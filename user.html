<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Temi Quiz</title>

<style>
/* GENERAL PAGE STYLES */
html,body{
  margin:0;padding:0;
  width:100%;height:100%;
  font-family:Arial, sans-serif;
  background:#f0f4ff;
  overflow:hidden;
}

/* SPLASH SCREEN */
#splash {
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:black;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:9999;
}

#splashText{
  font-size:4rem;
  font-weight:bold;
  letter-spacing:4px;
  animation:fade 3s infinite;
}

@keyframes fade{
  0%{opacity:0;} 
  50%{opacity:1;} 
  100%{opacity:0;}
}

/* QUIZ SCREEN */
#quizContainer{
  display:none;
  width:100%;height:100%;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:20px;
}

#question{
  font-size:2.7rem;
  font-weight:bold;
  margin-bottom:40px;
  padding:0 25px;
}

.answer{
  width:85%;
  padding:28px;
  margin:12px 0;
  font-size:2rem;
  border:none;
  border-radius:20px;
  background:linear-gradient(135deg,#5a8dee,#8868ff);
  color:white;
  cursor:pointer;
}

#rating button{
  width:110px;height:110px;
  border-radius:50%;
  font-size:2rem;
  margin:10px;
  background:#00aaff;
  color:white;
  border:none;
  cursor:pointer;
}

#speak{
  font-size:3.2rem;
  background:none;
  border:none;
  margin-bottom:20px;
  cursor:pointer;
}

/* NAVIGATION BUTTONS */
.navbtn{
  position:fixed;
  bottom:25px;
  padding:22px 30px;
  font-size:2rem;
  border:none;
  border-radius:18px;
  background:#333;
  color:white;
  cursor:pointer;
}
#prev { left:25px; }
#next { right:25px; }

</style>
</head>

<body>

<!-- SPLASH SCREEN -->
<div id="splash" onclick="startQuiz()">
  <div id="splashText">Allbotix</div>
</div>

<!-- QUIZ SCREEN -->
<div id="quizContainer">

  <button id="speak">ðŸ”Š</button>

  <div id="question">Loading...</div>

  <div id="options"></div>
  <div id="rating" style="display:none;"></div>

  <!-- Navigation Buttons -->
  <button id="prev" class="navbtn">â¬… Prev</button>
  <button id="next" class="navbtn">Next âž¡</button>

</div>

<script>
/*
 * Configuration: replace YOUR_WEBAPP_URL with the URL of your deployed Google Apps Script.
 * The Apps Script must return JSON from doGet() and accept POST requests for saving responses.
 */
const API_URL = "https://script.google.com/macros/s/AKfycbzVgZWYScmH7II7TK4rg3-tbZFW-sEdhFMqDUXCQZiUhc8KkW_5xzzVs6QlqprPoIlC/exec"; // TODO: replace this with your actual Web App URL

let questions = [];
let index = 0;

/**
 * Starts the quiz by hiding the splash screen and loading questions.
 */
function startQuiz(){
  document.getElementById("splash").style.display = "none";
  const quizContainer = document.getElementById("quizContainer");
  quizContainer.style.display = "flex";
  // ensure flex-direction is applied only after display is set
  quizContainer.style.flexDirection = "column";
  quizContainer.style.justifyContent = "center";
  quizContainer.style.alignItems = "center";
  loadQuestions();
}

/**
 * Fetches questions from the Google Apps Script Web App and filters by the enabled flag.
 * If no enabled questions exist, shows a message instead of attempting to display a question.
 */
function loadQuestions(){
  fetch(API_URL)
    .then(response => response.json())
    .then(data => {
      // Convert enabled value to string and lower-case to handle boolean and string cases
      questions = data.filter(q => String(q.enabled).toLowerCase() === "true");
      index = 0;
      if (questions.length === 0) {
        // No questions enabled, show a notice and exit gracefully
        const qDiv = document.getElementById("question");
        qDiv.textContent = "No questions available.";
        document.getElementById("options").innerHTML = "";
        document.getElementById("rating").style.display = "none";
        return;
      }
      showQuestion();
    })
    .catch(err => {
      console.error('Error loading questions:', err);
      const qDiv = document.getElementById("question");
      qDiv.textContent = "Error loading questions.";
      document.getElementById("options").innerHTML = "";
      document.getElementById("rating").style.display = "none";
    });
}

/**
 * Displays the current question and options (or rating buttons) based on its type.
 * Also triggers text-to-speech to read out the question and options.
 */
function showQuestion(){
  // If index is out of range or no questions remain, end the quiz
  if (index < 0 || index >= questions.length) {
    showCompletion();
    return;
  }

  const q = questions[index];
  document.getElementById("question").textContent = q.question;

  const opts = document.getElementById("options");
  const ratingDiv = document.getElementById("rating");

  opts.innerHTML = "";
  ratingDiv.innerHTML = "";
  ratingDiv.style.display = "none";

  // Show multiple choice buttons or rating buttons based on type
  if (q.type === "mcq") {
    const optionsArray = [q.option1, q.option2, q.option3, q.option4];
    optionsArray.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "answer";
      btn.textContent = opt;
      btn.onclick = () => saveAnswer(opt);
      opts.appendChild(btn);
    });
  } else {
    ratingDiv.style.display = "block";
    for (let i = 1; i <= 10; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.onclick = () => saveAnswer(i);
      ratingDiv.appendChild(btn);
    }
  }

  // After rendering the question, speak it with options
  speakQuestion();
}

/**
 * Uses the browser Speech Synthesis API to read out the question and options.
 */
function speakQuestion(){
  // Cancel any ongoing speech to avoid overlapping reads
  window.speechSynthesis.cancel();

  if (!questions.length || index < 0 || index >= questions.length) return;
  const q = questions[index];
  let text = `${q.question}. `;
  if (q.type === "mcq") {
    text += `Options are: ${q.option1}, ${q.option2}, ${q.option3}, ${q.option4}.`;
  } else {
    text += "Please rate from 1 to 10.";
  }
  const utterance = new SpeechSynthesisUtterance(text);
  window.speechSynthesis.speak(utterance);
}

// Bind speak button to read again
document.getElementById("speak").onclick = speakQuestion;

/**
 * Saves the user's answer by sending a POST request to the Apps Script. Then advances to the next question.
 * @param {string|number} ans The selected answer value
 */
function saveAnswer(ans){
  if (!questions.length) return;
  const q = questions[index];
  const params = new URLSearchParams();
  params.append('action', 'saveResponse');
  params.append('questionId', q.id);
  params.append('answer', ans);
  fetch(API_URL, { method: 'POST', body: params })
    .then(() => {
      // Move to next question or end the quiz
      index++;
      if (index < questions.length) {
        showQuestion();
      } else {
        showCompletion();
      }
    })
    .catch(err => {
      console.error('Error submitting answer:', err);
    });
}

/**
 * Handles the Next button event: advances to the next question if it exists.
 */
document.getElementById("next").onclick = function(){
  if (index < questions.length - 1) {
    index++;
    showQuestion();
  }
};

/**
 * Handles the Previous button event: goes back to the previous question if it exists.
 */
document.getElementById("prev").onclick = function(){
  if (index > 0) {
    index--;
    showQuestion();
  }
};

/**
 * Shows the completion screen and then returns to the splash screen after a delay.
 */
function showCompletion(){
  // Display a thank you message
  document.body.innerHTML =
    "<h1 style='font-size:3rem; text-align:center; margin-top:40%;'>Thank You ðŸŽ‰</h1>";
  // After 10 seconds, reload the page to show splash screen again
  setTimeout(() => { window.location.href = "user.html"; }, 10000);
}

</script>

</body>
</html>
